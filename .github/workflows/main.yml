name: All N1 im/op Build

on:
  schedule:
    # 🕒 定时触发：每天凌晨 3 点（北京时间）
    - cron: '0 19 * * *'  # GitHub Actions 用 UTC 时间，19:00 UTC = 北京时间 03:00
  workflow_dispatch:       # ✅ 允许手动触发

jobs:
  trigger:
    name: Trigger N1 Builds
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Trigger ImmortalWRT build
        id: trigger_im
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: im.yml
          ref: main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for ImmortalWRT build to start
        run: sleep 30

      - name: Trigger OpenWRT build
        id: trigger_op
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: op.yml
          ref: main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait a bit before checking statuses
        run: sleep 60

      # 🧭 检查两个工作流的最新运行状态
      - name: Check ImmortalWRT workflow status
        id: check_im
        run: |
          echo "🔍 检查 ImmortalWRT 工作流状态..."
          STATUS=$(gh run list --workflow "N1 ImmortalWRT docker Build" --limit 1 --json status,conclusion -q '.[0].conclusion' || echo "unknown")
          echo "ImmortalWRT_STATUS=$STATUS" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check OpenWRT workflow status
        id: check_op
        run: |
          echo "🔍 检查 OpenWRT 工作流状态..."
          STATUS=$(gh run list --workflow "N1 OpenWRT docker Build" --limit 1 --json status,conclusion -q '.[0].conclusion' || echo "unknown")
          echo "OpenWRT_STATUS=$STATUS" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ✅ 汇总结果
      - name: Report build summary
        run: |
          echo "=========================="
          echo "📦 N1 固件构建调度汇总"
          echo "=========================="
          echo "🕒 触发时间：$(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo
          echo "🧩 ImmortalWRT 构建状态：${{ env.ImmortalWRT_STATUS }}"
          echo "🧩 OpenWRT 构建状态：${{ env.OpenWRT_STATUS }}"
          echo
          if [[ "${{ env.ImmortalWRT_STATUS }}" == "success" && "${{ env.OpenWRT_STATUS }}" == "success" ]]; then
            echo "✅ 所有工作流构建成功！"
          else
            echo "⚠️ 有构建失败或未完成，请检查对应工作流日志。"
          fi
